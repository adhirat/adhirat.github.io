<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Welcome - Adhirat Portal</title>
    <meta name="robots" content="noindex, nofollow">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <!-- Tailwind Configuration -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Global Assets -->
    <link rel="stylesheet" href="../assets/css/styles.css">
    <script src="../assets/js/app.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #374151;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }

        .welcome-gradient {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 50%, rgba(236, 72, 153, 0.1) 100%);
        }

        .feature-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(10px);
        }

        .stat-glow {
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.1);
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }

        .action-badge {
            background: linear-gradient(135deg, #F59E0B 0%, #EF4444 100%);
        }
    </style>
</head>

<body
    class="pt-0 bg-background-light dark:bg-dark-bg text-slate-900 dark:text-white font-display antialiased overflow-hidden">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar Navigation -->
        <div id="portal-sidebar" class="contents"></div>

        <!-- Main Content Wrapper -->
        <main class="flex-1 flex flex-col min-w-0">
            <!-- Top Header -->
            <div id="portal-header" class="contents"></div>

            <!-- Dashboard Content Scrollable Area -->
            <div class="flex-1 overflow-y-auto">
                <!-- Hero Welcome Section -->
                <div class="welcome-gradient px-4 sm:px-8 py-12 border-b border-slate-200 dark:border-slate-800">
                    <div class="max-w-[1280px] mx-auto">
                        <div class="flex flex-col lg:flex-row items-center lg:items-start justify-between gap-8">
                            <div class="text-center lg:text-left">
                                <div
                                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-primary/10 text-primary text-sm font-semibold mb-4">
                                    <span class="material-symbols-outlined text-lg">waving_hand</span>
                                    <span id="greeting-text">Good morning</span>
                                </div>
                                <h1
                                    class="text-4xl lg:text-5xl font-bold tracking-tight text-slate-900 dark:text-white mb-4">
                                    Welcome back, <span class="text-gradient-animated" id="user-first-name">User</span>!
                                </h1>
                                <p class="text-lg text-slate-600 dark:text-slate-400 max-w-xl">
                                    Your central hub for managing everything. Here's what's happening today.
                                </p>
                            </div>
                            <div class="hidden lg:block">
                                <div class="relative">
                                    <div
                                        class="w-48 h-48 rounded-full bg-gradient-to-br from-primary/20 to-cyan-500/20 flex items-center justify-center float-animation">
                                        <div
                                            class="w-36 h-36 rounded-full bg-gradient-to-br from-primary to-cyan-500 flex items-center justify-center text-white">
                                            <span class="material-symbols-outlined text-6xl">rocket_launch</span>
                                        </div>
                                    </div>
                                    <div
                                        class="absolute -top-2 -right-2 w-12 h-12 rounded-full bg-emerald-500 flex items-center justify-center text-white shadow-lg">
                                        <span class="material-symbols-outlined">check</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-8 animate-fade-in-up">
                    <div class="max-w-[1280px] mx-auto flex flex-col gap-8">

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <div
                                class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm stat-glow card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                                        <span class="material-symbols-outlined text-2xl text-blue-500">inbox</span>
                                    </div>
                                    <span
                                        class="text-xs font-semibold text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded-full"
                                        id="new-messages-badge">0 new</span>
                                </div>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white" id="stat-messages">0</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Messages</p>
                            </div>
                            <div
                                class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm stat-glow card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl">
                                        <span class="material-symbols-outlined text-2xl text-emerald-500">group</span>
                                    </div>
                                    <span
                                        class="text-xs font-semibold text-emerald-500 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded-full">Active</span>
                                </div>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white" id="stat-subscribers">0</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Subscribers</p>
                            </div>
                            <div
                                class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm stat-glow card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
                                        <span class="material-symbols-outlined text-2xl text-purple-500">person</span>
                                    </div>
                                </div>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white" id="stat-users">0</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Portal Users</p>
                            </div>
                            <div
                                class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm stat-glow card-hover">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="p-3 bg-amber-50 dark:bg-amber-900/20 rounded-xl">
                                        <span class="material-symbols-outlined text-2xl text-amber-500">shield</span>
                                    </div>
                                </div>
                                <p class="text-3xl font-bold text-slate-900 dark:text-white" id="stat-roles">0</p>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Active Roles</p>
                            </div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- Pending Actions -->
                            <div
                                class="lg:col-span-2 bg-white dark:bg-dark-card rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                                <div
                                    class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-amber-100 dark:bg-amber-900/20 rounded-lg">
                                            <span
                                                class="material-symbols-outlined text-amber-600 dark:text-amber-400">pending_actions</span>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-slate-900 dark:text-white">Pending Actions</h3>
                                            <p class="text-xs text-slate-500">Items requiring your attention</p>
                                        </div>
                                    </div>
                                    <span class="action-badge text-white text-xs font-bold px-3 py-1 rounded-full"
                                        id="pending-count">0</span>
                                </div>
                                <div id="pending-actions-list"
                                    class="divide-y divide-slate-100 dark:divide-slate-800 max-h-[320px] overflow-y-auto">
                                    <div class="flex items-center justify-center py-12 text-slate-400">
                                        <span
                                            class="material-symbols-outlined text-4xl animate-spin">progress_activity</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Your Role & Permissions -->
                            <div
                                class="bg-white dark:bg-dark-card rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                                <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-purple-100 dark:bg-purple-900/20 rounded-lg">
                                            <span
                                                class="material-symbols-outlined text-purple-600 dark:text-purple-400">verified_user</span>
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-slate-900 dark:text-white">Your Access</h3>
                                            <p class="text-xs text-slate-500">Role & permissions</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-6">
                                    <div class="flex items-center gap-4 mb-6">
                                        <div class="w-16 h-16 rounded-2xl flex items-center justify-center text-white font-bold text-xl"
                                            id="role-badge"
                                            style="background: linear-gradient(135deg, #8B5CF6, #6366F1)">
                                            A
                                        </div>
                                        <div>
                                            <p class="text-xl font-bold text-slate-900 dark:text-white"
                                                id="user-role-name">Loading...</p>
                                            <p class="text-sm text-slate-500" id="user-role-desc">Fetching your role...
                                            </p>
                                        </div>
                                    </div>
                                    <div class="space-y-2 mb-6">
                                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wide">
                                            Permissions</p>
                                        <div id="permissions-preview" class="flex flex-wrap gap-2">
                                            <span
                                                class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs text-slate-600 dark:text-slate-400">Loading...</span>
                                        </div>
                                    </div>
                                    <a href="roles.html"
                                        class="flex items-center justify-center gap-2 w-full py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                                        data-permission="view_roles">
                                        <span class="material-symbols-outlined text-lg">shield</span>
                                        Manage Roles
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Access Features -->
                        <div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-4">Quick Access</h2>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <a href="users.html"
                                    class="feature-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all group card-hover"
                                    data-permission="view_users">
                                    <div
                                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-2xl">group</span>
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white mb-1">User Management</h3>
                                    <p class="text-sm text-slate-500">Manage users and roles</p>
                                </a>
                                <a href="submissions.html"
                                    class="feature-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all group card-hover"
                                    data-permission="view_submissions">
                                    <div
                                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-2xl">inbox</span>
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white mb-1">Form Submissions</h3>
                                    <p class="text-sm text-slate-500">View contact messages</p>
                                </a>
                                <a href="subscriptions.html"
                                    class="feature-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all group card-hover"
                                    data-permission="view_subscriptions">
                                    <div
                                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-2xl">mail</span>
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white mb-1">Subscriptions</h3>
                                    <p class="text-sm text-slate-500">Newsletter subscribers</p>
                                </a>
                                <a href="roles.html"
                                    class="feature-card p-6 rounded-2xl border border-slate-200 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all group card-hover"
                                    data-permission="view_roles">
                                    <div
                                        class="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform">
                                        <span class="material-symbols-outlined text-2xl">shield</span>
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white mb-1">Roles & Permissions</h3>
                                    <p class="text-sm text-slate-500">Configure access control</p>
                                </a>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div
                            class="bg-white dark:bg-dark-card rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-cyan-100 dark:bg-cyan-900/20 rounded-lg">
                                        <span
                                            class="material-symbols-outlined text-cyan-600 dark:text-cyan-400">history</span>
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white">Recent Activity</h3>
                                </div>
                            </div>
                            <div id="recent-activity" class="divide-y divide-slate-100 dark:divide-slate-800">
                                <div class="flex items-center justify-center py-8 text-slate-400">
                                    <span
                                        class="material-symbols-outlined text-4xl animate-spin">progress_activity</span>
                                </div>
                            </div>
                        </div>

                        <footer class="text-center text-sm text-slate-500 py-6">
                            Â© 2024 Adhirat Technologies. All rights reserved.
                        </footer>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import {
            initRBACGuard,
            getCurrentUserPermissions,
            getAllSubmissions,
            getAllSubscriptions,
            getAllUsersWithRoles,
            getAllRoles,
            initializeDefaultRoles,
            assignRoleToUser,
            PERMISSIONS
        } from '../assets/js/rbac.js';
        import { auth, db, doc, getDoc, setDoc, serverTimestamp, collection, getDocs, query, where } from '../assets/js/firebase-config.js';

        // Set greeting based on time
        function setGreeting() {
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';
            document.getElementById('greeting-text').textContent = greeting;
        }
        setGreeting();

        // Setup admin role for admin@adhirat.com
        async function setupAdminRole() {
            try {
                // First ensure default roles exist
                await initializeDefaultRoles();

                // Find admin@adhirat.com user and assign admin role
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', 'admin@adhirat.com'));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const userDoc = snapshot.docs[0];
                    const userData = userDoc.data();

                    if (userData.role !== 'admin') {
                        await assignRoleToUser(userDoc.id, 'admin');
                        console.log('Admin role assigned to admin@adhirat.com');
                    }
                }
            } catch (error) {
                console.error('Error setting up admin role:', error);
            }
        }

        // Initialize RBAC guard with callback
        initRBACGuard([], null, async (user, role, permissions) => {
            // Set user name
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const firstName = userData.fullName?.split(' ')[0] || userData.email?.split('@')[0] || 'User';
                document.getElementById('user-first-name').textContent = firstName;
            }

            // Setup admin if this is admin@adhirat.com
            if (user.email === 'admin@adhirat.com') {
                await setupAdminRole();
            }

            // Update role display
            if (role) {
                document.getElementById('user-role-name').textContent = role.name;
                document.getElementById('user-role-desc').textContent = role.description || 'Your current access level';
                document.getElementById('role-badge').textContent = role.name.charAt(0).toUpperCase();
                document.getElementById('role-badge').style.background = `linear-gradient(135deg, ${role.color}, ${adjustColor(role.color, -30)})`;

                // Show permissions preview
                const permissionsPreview = document.getElementById('permissions-preview');
                const displayPerms = permissions.slice(0, 5);
                permissionsPreview.innerHTML = displayPerms.map(p =>
                    `<span class="px-2 py-1 bg-primary/10 text-primary rounded text-xs font-medium">${formatPermission(p)}</span>`
                ).join('') + (permissions.length > 5 ? `<span class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded text-xs text-slate-500">+${permissions.length - 5} more</span>` : '');
            }

            // Load dashboard data
            loadDashboardData(permissions);
        });

        async function loadDashboardData(permissions) {
            try {
                // Get submissions count
                if (permissions.includes(PERMISSIONS.VIEW_SUBMISSIONS)) {
                    const subsResult = await getAllSubmissions();
                    if (subsResult.success) {
                        const submissions = subsResult.submissions;
                        const newCount = submissions.filter(s => s.status === 'new' || !s.status).length;
                        document.getElementById('stat-messages').textContent = submissions.length;
                        document.getElementById('new-messages-badge').textContent = `${newCount} new`;

                        // Update pending actions with new messages
                        updatePendingActions(submissions.filter(s => s.status === 'new' || !s.status));
                    }
                }

                // Get subscriptions count
                if (permissions.includes(PERMISSIONS.VIEW_SUBSCRIPTIONS)) {
                    const subsResult = await getAllSubscriptions();
                    if (subsResult.success) {
                        const active = subsResult.subscriptions.filter(s => !s.status || s.status === 'active').length;
                        document.getElementById('stat-subscribers').textContent = active;
                    }
                }

                // Get users count
                if (permissions.includes(PERMISSIONS.VIEW_USERS)) {
                    const usersResult = await getAllUsersWithRoles();
                    if (usersResult.success) {
                        document.getElementById('stat-users').textContent = usersResult.users.length;
                    }
                }

                // Get roles count
                if (permissions.includes(PERMISSIONS.VIEW_ROLES)) {
                    const rolesResult = await getAllRoles();
                    if (rolesResult.success) {
                        document.getElementById('stat-roles').textContent = rolesResult.roles.length;
                    }
                }

                // Load recent activity
                loadRecentActivity();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updatePendingActions(newMessages) {
            const container = document.getElementById('pending-actions-list');
            const countBadge = document.getElementById('pending-count');

            countBadge.textContent = newMessages.length;

            if (newMessages.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 text-center">
                        <div class="w-16 h-16 rounded-full bg-emerald-100 dark:bg-emerald-900/20 flex items-center justify-center mb-4">
                            <span class="material-symbols-outlined text-3xl text-emerald-500">check_circle</span>
                        </div>
                        <p class="font-semibold text-slate-900 dark:text-white">All caught up!</p>
                        <p class="text-sm text-slate-500">No pending actions at the moment.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = newMessages.slice(0, 5).map(msg => `
                <a href="submissions.html" class="flex items-center gap-4 p-4 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/20 flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined text-blue-500">mail</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-slate-900 dark:text-white truncate">${msg.name || 'New Message'}</p>
                        <p class="text-sm text-slate-500 truncate">${msg.message?.substring(0, 50) || 'No preview'}...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 text-xs font-semibold rounded-full">New</span>
                    </div>
                </a>
            `).join('') + (newMessages.length > 5 ? `
                <a href="submissions.html" class="flex items-center justify-center p-4 text-primary font-semibold hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                    View all ${newMessages.length} messages
                    <span class="material-symbols-outlined ml-1">arrow_forward</span>
                </a>
            ` : '');
        }

        function loadRecentActivity() {
            const container = document.getElementById('recent-activity');

            // Simulated recent activity - in real app, this would come from an activity log
            const activities = [
                { icon: 'login', color: 'emerald', text: 'You logged in', time: 'Just now' },
                { icon: 'dashboard', color: 'blue', text: 'Accessed dashboard', time: '2 minutes ago' }
            ];

            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="flex items-center justify-center py-8 text-slate-400">
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(a => `
                <div class="flex items-center gap-4 p-4">
                    <div class="w-10 h-10 rounded-full bg-${a.color}-100 dark:bg-${a.color}-900/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-${a.color}-500">${a.icon}</span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-slate-900 dark:text-white">${a.text}</p>
                        <p class="text-xs text-slate-500">${a.time}</p>
                    </div>
                </div>
            `).join('');
        }

        function formatPermission(perm) {
            return perm.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }

        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
            const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
            const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
    </script>
</body>

</html>