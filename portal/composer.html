<!DOCTYPE html>
<html class="dark" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Content Composer - Adhirat Tech</title>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&amp;display=swap"
    rel="stylesheet" />
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="stylesheet" href="../assets/css/styles.css">
  <script src="../assets/js/app.js"></script>
  <style>
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #3b4754;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #556677;
    }

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      font-size: 20px;
    }

    .icon-fill {
      font-variation-settings: 'FILL' 1;
    }

    [contenteditable]:empty:before {
      content: attr(data-placeholder);
      color: #64748b;
      pointer-events: none;
    }

    /* Block Editor */
    .composer-block {
      position: relative;
      border-radius: 0.5rem;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .composer-block:hover {
      background-color: rgba(241, 245, 249, 0.5);
    }

    .dark .composer-block:hover {
      background-color: rgba(30, 41, 59, 0.3);
    }

    .composer-block.selected {
      border-color: #3b82f6;
      background-color: rgba(59, 130, 246, 0.05);
    }

    .block-handle {
      position: absolute;
      left: -36px;
      top: 8px;
      cursor: grab;
      opacity: 0;
      transition: opacity 0.2s;
      display: flex;
      align-items: center;
      padding: 4px;
      border-radius: 6px;
      z-index: 10;
      color: #94a3b8;
      background: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .dark .block-handle {
      background: #1e293b;
    }

    .composer-block:hover .block-handle {
      opacity: 1;
    }

    .block-handle:hover {
      color: #3b82f6;
    }

    .composer-block.dragging {
      opacity: 0.4;
    }

    .composer-block.drag-over {
      border-color: #3b82f6;
      border-style: dashed;
    }

    .block-actions {
      position: absolute;
      right: 8px;
      top: 8px;
      opacity: 0;
      display: flex;
      flex-direction: row;
      gap: 2px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 4px;
      z-index: 20;
      transition: opacity 0.15s;
    }

    .dark .block-actions {
      background: #1e293b;
    }

    .composer-block:hover .block-actions {
      opacity: 1;
    }

    .block-actions:hover {
      opacity: 1;
    }

    .block-actions button {
      padding: 6px;
      border-radius: 4px;
      transition: background 0.15s;
    }

    .block-actions button:hover {
      background: #f1f5f9;
    }

    .dark .block-actions button:hover {
      background: #334155;
    }

    /* Layout Items in Sidebar */
    .layout-item {
      cursor: pointer;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      transition: all 0.2s;
      background: white;
    }

    .dark .layout-item {
      border-color: #334155;
      background: #1e293b;
    }

    .layout-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .layout-preview {
      display: grid;
      gap: 4px;
      height: 40px;
    }

    .layout-preview div {
      background: #e2e8f0;
      border-radius: 3px;
    }

    .dark .layout-preview div {
      background: #475569;
    }

    /* Column Layout */
    .column-row {
      display: grid;
      gap: 1rem;
    }

    .column-row.cols-2 {
      grid-template-columns: 1fr 1fr;
    }

    .column-row.cols-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .column-row.cols-4 {
      grid-template-columns: 1fr 1fr 1fr 1fr;
    }

    .column-row.cols-sidebar-left {
      grid-template-columns: 1fr 2fr;
    }

    .column-row.cols-sidebar-right {
      grid-template-columns: 2fr 1fr;
    }

    .column-cell {
      position: relative;
      min-height: 80px;
      border: 2px dashed #e2e8f0;
      border-radius: 0.5rem;
      background: rgba(248, 250, 252, 0.5);
      transition: all 0.2s;
    }

    .dark .column-cell {
      border-color: #334155;
      background: rgba(30, 41, 59, 0.3);
    }

    .column-cell:hover {
      border-color: #94a3b8;
    }

    .column-cell.has-content {
      border-style: solid;
      border-color: transparent;
      background: transparent;
    }

    .column-cell.has-content:hover {
      border-color: #e2e8f0;
    }

    .dark .column-cell.has-content:hover {
      border-color: #334155;
    }

    .cell-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.2s;
    }

    .cell-placeholder:hover {
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }

    .cell-content {
      padding: 0.5rem;
    }

    .cell-content[contenteditable] {
      outline: none;
      min-height: 40px;
    }

    /* Media */
    .media-placeholder {
      border: 2px dashed #cbd5e1;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dark .media-placeholder {
      border-color: #334155;
      background: #1e293b;
    }

    .media-placeholder:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }

    /* Insert Menu */
    .insert-menu {
      position: fixed;
      z-index: 100;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      padding: 8px;
      min-width: 220px;
    }

    .dark .insert-menu {
      background: #1e293b;
      border: 1px solid #334155;
    }

    .insert-menu button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      text-align: left;
      transition: all 0.15s;
    }

    .insert-menu button:hover {
      background: #f1f5f9;
    }

    .dark .insert-menu button:hover {
      background: #334155;
    }

    .insert-menu-divider {
      height: 1px;
      background: #e2e8f0;
      margin: 6px 0;
    }

    .dark .insert-menu-divider {
      background: #334155;
    }

    .insert-menu-title {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 8px 12px 4px;
    }

    /* Floating Toolbar */
    .floating-toolbar {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(10px);
      transition: all 0.2s ease;
    }

    .floating-toolbar.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    /* Sidebar Tabs */
    .sidebar-tab {
      border-bottom: 2px solid transparent;
    }

    .sidebar-tab.active-tab {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }

    .sidebar-tab:hover:not(.active-tab) {
      color: #64748b;
    }
  </style>
</head>

<body
  class="pt-0 bg-background-light dark:bg-dark-bg text-slate-900 dark:text-white font-display antialiased overflow-hidden selection:bg-primary/30 selection:text-white">
  <div class="flex h-screen w-full flex-row overflow-hidden">
    <div id="portal-sidebar" class="contents"></div>

    <div class="flex flex-1 flex-col h-full min-w-0 bg-background-light dark:bg-dark-bg relative">
      <div id="portal-header" class="contents"></div>

      <main class="flex flex-1 overflow-hidden relative">
        <!-- Left Column: Library -->
        <aside
          class="w-80 bg-gray-50 dark:bg-[#151a20] border-r border-gray-200 dark:border-slate-800 flex flex-col shrink-0 z-10"
          id="content-list-sidebar">
          <div class="p-4 border-b border-gray-200 dark:border-slate-800 flex flex-col gap-3">
            <h2 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">library_books</span> Library
            </h2>
            <!-- Search Input -->
            <div class="relative">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[18px]">search</span>
              <input type="text" id="library-search" placeholder="Search saved content..."
                class="w-full pl-10 pr-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all" />
            </div>
            <button id="btn-new-content"
              class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-blue-600 text-white py-2.5 rounded-lg font-medium transition-all shadow-lg shadow-primary/20 active:scale-95">
              <span class="material-symbols-outlined text-[20px]">add</span>
              <span>New Draft</span>
            </button>
          </div>

          <div class="px-4 py-3 flex gap-2 overflow-x-auto no-scrollbar border-b border-gray-200 dark:border-slate-800">
            <button
              class="px-3 py-1 text-xs font-medium rounded-full bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 transition-colors whitespace-nowrap active-filter"
              data-filter="all">All</button>
            <button
              class="px-3 py-1 text-xs font-medium rounded-full bg-transparent border border-slate-200 dark:border-slate-700 text-slate-500 transition-colors whitespace-nowrap"
              data-filter="article">Articles</button>
            <button
              class="px-3 py-1 text-xs font-medium rounded-full bg-transparent border border-slate-200 dark:border-slate-700 text-slate-500 transition-colors whitespace-nowrap"
              data-filter="email">Emails</button>
            <button
              class="px-3 py-1 text-xs font-medium rounded-full bg-transparent border border-slate-200 dark:border-slate-700 text-slate-500 transition-colors whitespace-nowrap"
              data-filter="casestudy">Cases</button>
          </div>

          <!-- Sidebar Tabs -->
          <div class="flex border-b border-gray-200 dark:border-slate-800">
            <button
              class="flex-1 py-2 text-xs font-bold uppercase tracking-wider text-center transition-colors sidebar-tab active-tab"
              data-tab="content">Saved</button>
            <button
              class="flex-1 py-2 text-xs font-bold uppercase tracking-wider text-center text-slate-400 transition-colors sidebar-tab"
              data-tab="layouts">Layouts</button>
          </div>

          <!-- Saved Content List -->
          <div class="flex-1 overflow-y-auto p-2 space-y-1 tab-panel" id="saved-content-list" data-panel="content">
            <div class="flex flex-col items-center justify-center h-40 text-slate-400">
              <span class="material-symbols-outlined animate-spin mb-2">progress_activity</span>
              <span class="text-xs">Loading...</span>
            </div>
          </div>

          <!-- Layouts Panel -->
          <div class="flex-1 overflow-y-auto p-3 space-y-3 tab-panel hidden" id="layouts-panel" data-panel="layouts">
            <p class="text-xs text-slate-400 mb-2">Click to insert into composer</p>

            <!-- 2 Columns -->
            <div class="layout-item" onclick="insertBlock('row-2')">
              <div class="layout-preview" style="grid-template-columns: 1fr 1fr;">
                <div></div>
                <div></div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">2 Columns</p>
            </div>

            <!-- 3 Columns -->
            <div class="layout-item" onclick="insertBlock('row-3')">
              <div class="layout-preview" style="grid-template-columns: 1fr 1fr 1fr;">
                <div></div>
                <div></div>
                <div></div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">3 Columns</p>
            </div>

            <!-- 4 Columns -->
            <div class="layout-item" onclick="insertBlock('row-4')">
              <div class="layout-preview" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">4 Columns</p>
            </div>

            <!-- Sidebar Left -->
            <div class="layout-item" onclick="insertBlock('row-sidebar-left')">
              <div class="layout-preview" style="grid-template-columns: 1fr 2fr;">
                <div></div>
                <div></div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">Sidebar Left</p>
            </div>

            <!-- Sidebar Right -->
            <div class="layout-item" onclick="insertBlock('row-sidebar-right')">
              <div class="layout-preview" style="grid-template-columns: 2fr 1fr;">
                <div></div>
                <div></div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">Sidebar Right</p>
            </div>

            <!-- Stats Row -->
            <div class="layout-item" onclick="insertBlock('stats-row')">
              <div class="layout-preview" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="flex items-center justify-center text-[10px] text-slate-500">123</div>
                <div class="flex items-center justify-center text-[10px] text-slate-500">456</div>
                <div class="flex items-center justify-center text-[10px] text-slate-500">789</div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">Stats / Metrics Row</p>
            </div>

            <!-- Hero Section -->
            <div class="layout-item" onclick="insertBlock('hero')">
              <div class="layout-preview" style="grid-template-columns: 1fr;">
                <div class="h-full bg-gradient-to-r from-blue-200 to-purple-200 dark:from-blue-900 dark:to-purple-900">
                </div>
              </div>
              <p class="text-xs font-medium text-slate-700 dark:text-slate-300 mt-2">Hero Section</p>
            </div>
          </div>
        </aside>

        <!-- Right Column: Editor -->
        <div class="flex-1 overflow-hidden relative bg-background-light dark:bg-dark-bg flex flex-col"
          id="center-canvas-container">

          <!-- Template Selection -->
          <div id="template-gallery"
            class="flex flex-1 flex-col items-center justify-center p-8 animate-fade-in-up bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-100 via-background-light to-background-light dark:from-slate-900 dark:via-dark-bg dark:to-dark-bg relative z-10">
            <div class="max-w-4xl w-full">
              <div class="text-center mb-10">
                <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white mb-2">Start Writing</h2>
                <p class="text-slate-500 dark:text-slate-400">Select a content type to begin.</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="selectTemplate('article')"
                  class="group p-6 rounded-2xl bg-white dark:bg-[#151a20] border border-gray-200 dark:border-slate-800 hover:border-blue-500/50 shadow-sm hover:shadow-xl transition-all flex flex-col items-center active:scale-95">
                  <div
                    class="size-16 rounded-full bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    <span class="material-symbols-outlined text-3xl">article</span>
                  </div>
                  <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">Article</h3>
                  <p class="text-xs text-center text-slate-500">Blog posts & updates</p>
                </button>
                <button onclick="selectTemplate('email')"
                  class="group p-6 rounded-2xl bg-white dark:bg-[#151a20] border border-gray-200 dark:border-slate-800 hover:border-green-500/50 shadow-sm hover:shadow-xl transition-all flex flex-col items-center active:scale-95">
                  <div
                    class="size-16 rounded-full bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    <span class="material-symbols-outlined text-3xl">mail</span>
                  </div>
                  <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">Email</h3>
                  <p class="text-xs text-center text-slate-500">Newsletters & comms</p>
                </button>
                <button onclick="selectTemplate('casestudy')"
                  class="group p-6 rounded-2xl bg-white dark:bg-[#151a20] border border-gray-200 dark:border-slate-800 hover:border-purple-500/50 shadow-sm hover:shadow-xl transition-all flex flex-col items-center active:scale-95">
                  <div
                    class="size-16 rounded-full bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                    <span class="material-symbols-outlined text-3xl">work_history</span>
                  </div>
                  <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">Case Study</h3>
                  <p class="text-xs text-center text-slate-500">Success stories</p>
                </button>
              </div>
            </div>
          </div>

          <!-- Editor Wrapper -->
          <div id="editor-wrapper" class="hidden flex-col h-full bg-white dark:bg-[#0f172a]">
            <!-- Top Bar -->
            <div
              class="sticky top-0 z-20 bg-white dark:bg-[#0f172a]/90 backdrop-blur-sm border-b border-gray-200 dark:border-slate-800 px-6 py-3 flex flex-wrap gap-4 justify-between items-center">
              <div class="flex items-center gap-4">
                <div
                  class="flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-500 bg-gray-100 dark:bg-slate-800 px-3 py-1.5 rounded-md">
                  <span class="material-symbols-outlined text-[16px]" id="current-type-icon">article</span>
                  <span id="current-type-label">Article</span>
                </div>
                <div class="h-4 w-px bg-gray-300 dark:bg-slate-700"></div>
                <span class="text-xs font-medium text-slate-400 flex items-center gap-1.5" id="last-saved-status">
                  <span class="size-2 rounded-full bg-slate-300 dark:bg-slate-600"></span> Unsaved
                </span>
              </div>
              <div class="flex items-center gap-3">
                <select id="meta-status"
                  class="bg-transparent text-sm font-medium text-slate-600 dark:text-slate-300 focus:outline-none cursor-pointer border-none p-0 pr-6">
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                </select>
                <button id="btn-delete" class="p-2 text-slate-400 hover:text-red-500 transition-colors hidden"
                  title="Delete">
                  <span class="material-symbols-outlined text-[20px]">delete</span>
                </button>
                <button id="btn-preview"
                  class="px-4 py-1.5 rounded-lg border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 text-sm font-medium hover:bg-slate-100 dark:hover:bg-slate-700 transition-all flex items-center gap-2"
                  title="Preview">
                  <span class="material-symbols-outlined text-[16px]">visibility</span> Preview
                </button>
                <button id="btn-save"
                  class="px-4 py-1.5 rounded-lg bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center gap-2">
                  <span class="material-symbols-outlined text-[16px]">save</span> Save
                </button>
              </div>
            </div>

            <!-- Editor Content Area -->
            <div class="flex-1 overflow-y-auto px-6 md:px-16 py-8">
              <div class="max-w-3xl mx-auto min-h-[500px] pb-32">
                <div class="mb-6">
                  <h1 id="editor-title"
                    class="text-4xl font-extrabold text-slate-900 dark:text-white leading-tight outline-none"
                    contenteditable="true" data-placeholder="Enter title here..."></h1>
                </div>
                <div class="mb-8 flex items-center gap-2 text-sm text-slate-500">
                  <span class="material-symbols-outlined text-[18px]">label</span>
                  <input id="meta-tags"
                    class="bg-transparent border-none p-0 w-full focus:ring-0 placeholder:text-slate-400"
                    placeholder="Add tags (comma separated)..." />
                </div>
                <div id="editor-content" class="space-y-4"></div>
                <div class="mt-6 flex justify-center">
                  <button id="add-block-btn"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-700 text-slate-400 hover:text-primary hover:border-primary transition-all">
                    <span class="material-symbols-outlined">add</span>
                    <span class="text-sm font-medium">Add Block</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Floating Toolbar (Hidden by default) -->
            <div id="floating-toolbar" class="floating-toolbar absolute bottom-6 left-1/2 z-30">
              <div
                class="flex items-center gap-1 p-2 rounded-xl bg-slate-900/95 border border-slate-700/50 shadow-2xl backdrop-blur-md">

                <!-- Text Type Dropdown -->
                <div class="relative">
                  <button id="text-type-btn" onclick="toggleTextTypeMenu()"
                    class="h-9 px-3 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center gap-1 text-sm font-medium"
                    title="Text Type">
                    <span id="text-type-label">Normal</span>
                    <span class="material-symbols-outlined text-[14px]">expand_more</span>
                  </button>
                  <div id="text-type-menu"
                    class="hidden absolute bottom-full left-0 mb-2 bg-slate-800 rounded-lg shadow-xl border border-slate-700 py-1 min-w-[140px]">
                    <button onclick="setTextType('H1')"
                      class="w-full px-3 py-2 text-left text-white hover:bg-white/10 text-lg font-bold">Heading
                      1</button>
                    <button onclick="setTextType('H2')"
                      class="w-full px-3 py-2 text-left text-white hover:bg-white/10 text-base font-bold">Heading
                      2</button>
                    <button onclick="setTextType('H3')"
                      class="w-full px-3 py-2 text-left text-white hover:bg-white/10 text-sm font-bold">Heading
                      3</button>
                    <div class="h-px bg-slate-700 my-1"></div>
                    <button onclick="setTextType('P')"
                      class="w-full px-3 py-2 text-left text-white hover:bg-white/10 text-sm">Normal</button>
                    <button onclick="setTextType('BLOCKQUOTE')"
                      class="w-full px-3 py-2 text-left text-white hover:bg-white/10 text-sm italic">Quote</button>
                  </div>
                </div>

                <div class="w-px h-4 bg-white/20 mx-1"></div>

                <!-- Text Formatting -->
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('bold')" title="Bold (Ctrl+B)">
                  <span class="material-symbols-outlined text-[18px]">format_bold</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('italic')" title="Italic (Ctrl+I)">
                  <span class="material-symbols-outlined text-[18px]">format_italic</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('underline')" title="Underline (Ctrl+U)">
                  <span class="material-symbols-outlined text-[18px]">format_underlined</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('strikeThrough')" title="Strikethrough">
                  <span class="material-symbols-outlined text-[18px]">strikethrough_s</span>
                </button>

                <div class="w-px h-4 bg-white/20 mx-1"></div>

                <!-- Text Alignment -->
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('justifyLeft')" title="Align Left">
                  <span class="material-symbols-outlined text-[18px]">format_align_left</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('justifyCenter')" title="Align Center">
                  <span class="material-symbols-outlined text-[18px]">format_align_center</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="execCmd('justifyRight')" title="Align Right">
                  <span class="material-symbols-outlined text-[18px]">format_align_right</span>
                </button>

                <div class="w-px h-4 bg-white/20 mx-1"></div>

                <!-- Lists -->
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="toggleList('insertUnorderedList')" title="Bullet List">
                  <span class="material-symbols-outlined text-[18px]">format_list_bulleted</span>
                </button>
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="toggleList('insertOrderedList')" title="Numbered List">
                  <span class="material-symbols-outlined text-[18px]">format_list_numbered</span>
                </button>

                <div class="w-px h-4 bg-white/20 mx-1"></div>

                <!-- Link -->
                <button
                  class="size-9 rounded-lg text-white hover:bg-white/20 transition-colors flex items-center justify-center"
                  onclick="insertLink()" title="Insert Link">
                  <span class="material-symbols-outlined text-[18px]">link</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Insert Block Menu -->
  <div id="insert-menu" class="insert-menu hidden">
    <div class="insert-menu-title">Content</div>
    <button onclick="insertBlock('text')"><span class="material-symbols-outlined text-blue-500">text_fields</span> <span
        class="text-slate-700 dark:text-slate-200">Text Block</span></button>
    <button onclick="insertBlock('heading')"><span class="material-symbols-outlined text-purple-500">title</span> <span
        class="text-slate-700 dark:text-slate-200">Heading</span></button>
    <button onclick="insertBlock('image')"><span class="material-symbols-outlined text-green-500">image</span> <span
        class="text-slate-700 dark:text-slate-200">Image</span></button>
    <button onclick="insertBlock('video')"><span class="material-symbols-outlined text-red-500">play_circle</span> <span
        class="text-slate-700 dark:text-slate-200">Video Embed</span></button>
    <div class="insert-menu-divider"></div>
    <div class="insert-menu-title">Multi-Column Rows</div>
    <button onclick="insertBlock('row-2')"><span class="material-symbols-outlined text-orange-500">view_column_2</span>
      <span class="text-slate-700 dark:text-slate-200">2 Columns</span></button>
    <button onclick="insertBlock('row-3')"><span class="material-symbols-outlined text-cyan-500">grid_view</span> <span
        class="text-slate-700 dark:text-slate-200">3 Columns</span></button>
    <button onclick="insertBlock('row-4')"><span class="material-symbols-outlined text-indigo-500">view_week</span>
      <span class="text-slate-700 dark:text-slate-200">4 Columns</span></button>
    <button onclick="insertBlock('row-sidebar-left')"><span
        class="material-symbols-outlined text-teal-500">view_sidebar</span> <span
        class="text-slate-700 dark:text-slate-200">Sidebar Left</span></button>
    <button onclick="insertBlock('row-sidebar-right')"><span
        class="material-symbols-outlined text-amber-500">view_sidebar</span> <span
        class="text-slate-700 dark:text-slate-200">Sidebar Right</span></button>
    <div class="insert-menu-divider"></div>
    <div class="insert-menu-title">Other</div>
    <button onclick="insertBlock('quote')"><span class="material-symbols-outlined text-pink-500">format_quote</span>
      <span class="text-slate-700 dark:text-slate-200">Quote / Callout</span></button>
    <button onclick="insertBlock('divider')"><span
        class="material-symbols-outlined text-slate-400">horizontal_rule</span> <span
        class="text-slate-700 dark:text-slate-200">Divider</span></button>
  </div>

  <!-- Cell Content Menu (for columns) -->
  <div id="cell-menu" class="insert-menu hidden">
    <div class="insert-menu-title">Add to Cell</div>
    <button onclick="insertCellContent('text')"><span class="material-symbols-outlined text-blue-500">text_fields</span>
      <span class="text-slate-700 dark:text-slate-200">Text</span></button>
    <button onclick="insertCellContent('heading')"><span class="material-symbols-outlined text-purple-500">title</span>
      <span class="text-slate-700 dark:text-slate-200">Heading</span></button>
    <button onclick="insertCellContent('image')"><span class="material-symbols-outlined text-green-500">image</span>
      <span class="text-slate-700 dark:text-slate-200">Image</span></button>
    <button onclick="insertCellContent('video')"><span class="material-symbols-outlined text-red-500">play_circle</span>
      <span class="text-slate-700 dark:text-slate-200">Video</span></button>
    <button onclick="insertCellContent('stats')"><span
        class="material-symbols-outlined text-orange-500">monitoring</span> <span
        class="text-slate-700 dark:text-slate-200">Stat/Metric</span></button>
  </div>

  <!-- Preview Modal -->
  <div id="preview-modal" class="fixed inset-0 z-[100] hidden">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closePreview()"></div>

    <!-- Modal Content -->
    <div class="relative z-10 flex flex-col h-full">
      <!-- Header -->
      <div class="flex items-center justify-between px-6 py-4 bg-slate-900 border-b border-slate-700">
        <div class="flex items-center gap-4">
          <h3 class="text-white font-bold text-lg">Preview</h3>
          <!-- Device Switcher -->
          <div class="flex items-center bg-slate-800 rounded-lg p-1">
            <button onclick="setPreviewDevice('mobile')" class="preview-device-btn active" data-device="mobile"
              title="Mobile (375px)">
              <span class="material-symbols-outlined text-[20px]">smartphone</span>
            </button>
            <button onclick="setPreviewDevice('tablet')" class="preview-device-btn" data-device="tablet"
              title="Tablet (768px)">
              <span class="material-symbols-outlined text-[20px]">tablet</span>
            </button>
            <button onclick="setPreviewDevice('desktop')" class="preview-device-btn" data-device="desktop"
              title="Desktop (100%)">
              <span class="material-symbols-outlined text-[20px]">desktop_windows</span>
            </button>
          </div>
        </div>
        <button onclick="closePreview()"
          class="p-2 text-slate-400 hover:text-white transition-colors rounded-lg hover:bg-slate-700">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Preview Frame Container -->
      <div class="flex-1 flex items-center justify-center p-8 overflow-auto">
        <div id="preview-frame" class="bg-white rounded-lg shadow-2xl transition-all duration-300 overflow-hidden"
          style="width: 375px; height: 667px;">
          <div id="preview-content" class="w-full h-full overflow-auto p-6">
            <!-- Content will be injected here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .preview-device-btn {
      padding: 0.375rem 0.75rem;
      border-radius: 0.5rem;
      color: rgb(148 163 184);
      transition: color 0.15s;
    }

    .preview-device-btn:hover {
      color: white;
    }

    .preview-device-btn.active {
      background-color: var(--color-primary, #3b82f6);
      color: white;
    }
  </style>
  <script type="module">
    import { initAuthObserver, saveContent, fetchContents, deleteContent } from "../assets/js/firebase-modules.js";

    // Initialize auth with callback to load contents when ready
    initAuthObserver(true, () => {
      loadContents();
    });

    // State
    let currentId = null;
    let currentType = 'article';
    let allContents = [];
    let activeCell = null;

    // Elements
    const titleEl = document.getElementById('editor-title');
    const contentEl = document.getElementById('editor-content');
    const statusEl = document.getElementById('last-saved-status');
    const listEl = document.getElementById('saved-content-list');
    const typeLabel = document.getElementById('current-type-label');
    const typeIcon = document.getElementById('current-type-icon');
    const metaStatus = document.getElementById('meta-status');
    const metaTags = document.getElementById('meta-tags');
    const deleteBtn = document.getElementById('btn-delete');
    const templateGallery = document.getElementById('template-gallery');
    const editorWrapper = document.getElementById('editor-wrapper');
    const insertMenu = document.getElementById('insert-menu');
    const cellMenu = document.getElementById('cell-menu');
    const addBlockBtn = document.getElementById('add-block-btn');
    const floatingToolbar = document.getElementById('floating-toolbar');

    // --- Floating Toolbar Visibility ---
    function showToolbar() {
      floatingToolbar.classList.add('visible');
    }
    function hideToolbar() {
      floatingToolbar.classList.remove('visible');
    }

    // Track focus on text elements
    document.addEventListener('focusin', (e) => {
      const target = e.target;
      if (target.contentEditable === 'true' &&
        (target.closest('.block-content') || target.closest('.cell-content')) &&
        !target.closest('.media-placeholder')) {
        showToolbar();
      }
    });

    document.addEventListener('focusout', (e) => {
      // Delay to allow clicking toolbar buttons
      setTimeout(() => {
        const active = document.activeElement;
        if (!active.contentEditable || active.contentEditable !== 'true') {
          if (!floatingToolbar.matches(':hover')) {
            hideToolbar();
          }
        }
      }, 100);
    });

    // Keep toolbar visible when hovering over it
    floatingToolbar.addEventListener('mouseenter', showToolbar);
    floatingToolbar.addEventListener('mouseleave', () => {
      const active = document.activeElement;
      if (!active.contentEditable || active.contentEditable !== 'true') {
        hideToolbar();
      }
    });

    // Templates
    const templates = {
      article: {
        title: "The Future of [Topic]",
        blocks: [
          { type: 'text', content: '<p class="text-xl text-slate-500 italic">"Add a compelling lead paragraph here."</p>' },
          { type: 'image', content: '' },
          { type: 'heading', content: '<h2>Introduction</h2>' },
          { type: 'text', content: '<p>Start your article with context and why this topic matters.</p>' },
          { type: 'heading', content: '<h2>Key Points</h2>' },
          { type: 'text', content: '<ul><li><strong>Point 1:</strong> First insight.</li><li><strong>Point 2:</strong> Second insight.</li></ul>' },
          { type: 'heading', content: '<h2>Conclusion</h2>' },
          { type: 'text', content: '<p>Summarize and include a call to action.</p>' }
        ],
        config: { label: 'Article', icon: 'article' }
      },
      email: {
        title: "Project Update: [Project Name]",
        blocks: [
          { type: 'text', content: '<p>Hi [Name],</p>' },
          { type: 'text', content: '<p>I wanted to share a quick update on <strong>[Project Name]</strong>.</p>' },
          { type: 'heading', content: '<h3>Progress Summary</h3>' },
          { type: 'text', content: '<ul><li>âœ… Milestone A completed</li><li>ðŸ”„ Milestone B in progress</li></ul>' },
          { type: 'divider', content: '' },
          { type: 'text', content: '<p>Best regards,<br><strong>[Your Name]</strong></p>' }
        ],
        config: { label: 'Email', icon: 'mail' }
      },
      casestudy: {
        title: "Case Study: [Client Name]",
        blocks: [
          {
            type: 'row-3', content: {
              cells: [
                { type: 'stats', content: '<div class="text-center"><div class="text-3xl font-bold text-primary">200%</div><div class="text-xs uppercase text-slate-500 mt-1">ROI Increase</div></div>' },
                { type: 'stats', content: '<div class="text-center"><div class="text-3xl font-bold text-green-500">3 Weeks</div><div class="text-xs uppercase text-slate-500 mt-1">Implementation</div></div>' },
                { type: 'stats', content: '<div class="text-center"><div class="text-3xl font-bold text-purple-500">50+</div><div class="text-xs uppercase text-slate-500 mt-1">Automated</div></div>' }
              ]
            }
          },
          { type: 'heading', content: '<h2>ðŸŽ¯ The Challenge</h2>' },
          { type: 'text', content: '<p>[Client Name] faced challenges with outdated systems.</p>' },
          { type: 'heading', content: '<h2>ðŸ’¡ The Solution</h2>' },
          {
            type: 'row-2', content: {
              cells: [
                { type: 'text', content: '<p>We implemented a custom solution that automated key workflows and provided real-time analytics.</p>' },
                { type: 'image', content: '' }
              ]
            }
          },
          { type: 'heading', content: '<h2>ðŸ“ˆ The Results</h2>' },
          { type: 'quote', content: '<blockquote>"This transformed our operations."<footer>â€” CTO, [Client Name]</footer></blockquote>' }
        ],
        config: { label: 'Case Study', icon: 'work_history' }
      }
    };

    // --- Block Creation ---
    function createBlock(type, content = '') {
      const wrapper = document.createElement('div');
      wrapper.className = 'composer-block group relative';
      wrapper.dataset.type = type;
      wrapper.draggable = true;

      // Handle
      const handle = document.createElement('div');
      handle.className = 'block-handle';
      handle.innerHTML = `<span class="material-symbols-outlined text-[16px]">drag_indicator</span>`;
      wrapper.appendChild(handle);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'block-actions';
      actions.innerHTML = `
        <button class="p-1 hover:text-blue-500 text-slate-400" title="Duplicate" onclick="duplicateBlock(this)"><span class="material-symbols-outlined text-[16px]">content_copy</span></button>
        <button class="p-1 hover:text-red-500 text-slate-400" title="Delete" onclick="deleteBlock(this)"><span class="material-symbols-outlined text-[16px]">delete</span></button>
      `;
      wrapper.appendChild(actions);

      // Content
      const contentDiv = document.createElement('div');
      contentDiv.className = 'block-content';

      if (type.startsWith('row-')) {
        // Multi-column row
        const colType = type.replace('row-', '');
        const colClass = colType === 'sidebar-left' ? 'cols-sidebar-left' :
          colType === 'sidebar-right' ? 'cols-sidebar-right' :
            `cols-${colType}`;
        const numCols = colType === 'sidebar-left' || colType === 'sidebar-right' ? 2 : parseInt(colType);

        let cellsHTML = '';
        const cellData = typeof content === 'object' && content.cells ? content.cells : null;

        for (let i = 0; i < numCols; i++) {
          if (cellData && cellData[i]) {
            const c = cellData[i];
            cellsHTML += `<div class="column-cell has-content" data-cell-type="${c.type}"><div class="cell-content">${c.content}</div></div>`;
          } else {
            cellsHTML += `<div class="column-cell"><div class="cell-placeholder" onclick="openCellMenu(this, event)"><span class="material-symbols-outlined text-2xl">add</span><span class="text-xs mt-1">Add Content</span></div></div>`;
          }
        }
        contentDiv.innerHTML = `<div class="column-row ${colClass}">${cellsHTML}</div>`;
      } else {
        switch (type) {
          case 'text':
            contentDiv.innerHTML = content || '<p>Enter your text here. You can format it using the toolbar below.</p>';
            contentDiv.contentEditable = true;
            contentDiv.className += ' prose prose-slate dark:prose-invert max-w-none focus:outline-none';
            break;
          case 'heading':
            contentDiv.innerHTML = content || '<h2>Section Heading</h2>';
            contentDiv.contentEditable = true;
            contentDiv.className += ' prose prose-slate dark:prose-invert max-w-none focus:outline-none';
            break;
          case 'image':
            contentDiv.innerHTML = content || `
              <div class="media-placeholder" onclick="uploadImage(this)">
                <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">add_photo_alternate</span>
                <span class="text-sm text-slate-500">Click to add image</span>
                <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this)" />
              </div>
            `;
            break;
          case 'video':
            contentDiv.innerHTML = content || `
              <div class="media-placeholder" onclick="promptVideoUrl(this)">
                <span class="material-symbols-outlined text-4xl text-slate-400 mb-2">video_library</span>
                <span class="text-sm text-slate-500">Click to embed video</span>
              </div>
            `;
            break;
          case 'quote':
            contentDiv.innerHTML = content || '<blockquote class="border-l-4 border-primary pl-4 italic text-lg text-slate-600 dark:text-slate-300" contenteditable="true">"Add your quote or callout text here."</blockquote>';
            break;
          case 'divider':
            contentDiv.innerHTML = '<hr class="border-slate-200 dark:border-slate-700 my-4" />';
            break;
          case 'stats-row':
            contentDiv.innerHTML = `
              <div class="column-row cols-3">
                <div class="column-cell has-content" data-cell-type="stats"><div class="cell-content text-center py-4"><div class="text-3xl font-bold text-primary" contenteditable="true">100%</div><div class="text-xs uppercase tracking-wider text-slate-500 mt-1" contenteditable="true">Metric One</div></div></div>
                <div class="column-cell has-content" data-cell-type="stats"><div class="cell-content text-center py-4"><div class="text-3xl font-bold text-green-500" contenteditable="true">50+</div><div class="text-xs uppercase tracking-wider text-slate-500 mt-1" contenteditable="true">Metric Two</div></div></div>
                <div class="column-cell has-content" data-cell-type="stats"><div class="cell-content text-center py-4"><div class="text-3xl font-bold text-purple-500" contenteditable="true">24/7</div><div class="text-xs uppercase tracking-wider text-slate-500 mt-1" contenteditable="true">Metric Three</div></div></div>
              </div>
            `;
            break;
          case 'hero':
            contentDiv.innerHTML = `
              <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl p-8 text-center text-white">
                <h2 class="text-3xl font-bold mb-2" contenteditable="true">Hero Section Title</h2>
                <p class="text-lg opacity-90 mb-4" contenteditable="true">Add a compelling subtitle or description here.</p>
                <button class="px-6 py-2 bg-white text-blue-600 font-bold rounded-lg">Call to Action</button>
              </div>
            `;
            break;
          default:
            contentDiv.innerHTML = content || '<p>Enter text here...</p>';
            contentDiv.contentEditable = true;
        }
      }

      wrapper.appendChild(contentDiv);

      // Events
      wrapper.addEventListener('click', (e) => {
        if (!e.target.closest('.block-actions') && !e.target.closest('.cell-placeholder')) {
          selectBlock(wrapper);
          // If clicking the wrapper itself (not the content), blur to enable delete shortcut
          if (e.target === wrapper || e.target.classList.contains('block-handle')) {
            document.activeElement?.blur();
          }
        }
      });
      wrapper.addEventListener('dragstart', handleDragStart);
      wrapper.addEventListener('dragover', handleDragOver);
      wrapper.addEventListener('drop', handleDrop);
      wrapper.addEventListener('dragend', handleDragEnd);

      return wrapper;
    }

    window.selectBlock = function (block) {
      document.querySelectorAll('.composer-block').forEach(b => b.classList.remove('selected'));
      block.classList.add('selected');
    }

    // --- Cell Menu ---
    window.openCellMenu = (placeholder, event) => {
      event.stopPropagation();
      activeCell = placeholder.closest('.column-cell');
      const rect = placeholder.getBoundingClientRect();
      cellMenu.style.left = `${rect.left + rect.width / 2 - 110}px`;
      cellMenu.style.top = `${rect.bottom + 10}px`;
      cellMenu.classList.remove('hidden');
    };

    window.insertCellContent = (type) => {
      if (!activeCell) return;

      let html = '';
      switch (type) {
        case 'text':
          html = '<div class="cell-content prose prose-slate dark:prose-invert" contenteditable="true" data-placeholder="Type here..."><p></p></div>';
          break;
        case 'heading':
          html = '<div class="cell-content prose prose-slate dark:prose-invert" contenteditable="true"><h3 data-placeholder="Heading..."></h3></div>';
          break;
        case 'image':
          html = `<div class="cell-content"><div class="media-placeholder" onclick="uploadImage(this)"><span class="material-symbols-outlined text-3xl text-slate-400 mb-1">add_photo_alternate</span><span class="text-xs text-slate-500">Add Image</span><input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(this)" /></div></div>`;
          break;
        case 'video':
          html = `<div class="cell-content"><div class="media-placeholder" onclick="promptVideoUrl(this)"><span class="material-symbols-outlined text-3xl text-slate-400 mb-1">video_library</span><span class="text-xs text-slate-500">Embed Video</span></div></div>`;
          break;
        case 'stats':
          html = '<div class="cell-content text-center py-4"><div class="text-3xl font-bold text-primary" contenteditable="true">100%</div><div class="text-xs uppercase tracking-wider text-slate-500 mt-1" contenteditable="true">Metric Label</div></div>';
          break;
      }

      activeCell.innerHTML = html;
      activeCell.classList.add('has-content');
      activeCell.dataset.cellType = type;
      cellMenu.classList.add('hidden');
      activeCell = null;

      // Focus if text
      const editable = activeCell?.querySelector('[contenteditable]');
      if (editable) editable.focus();
    };

    // --- Drag & Drop ---
    let draggedItem = null;

    function handleDragStart(e) {
      draggedItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
      e.preventDefault();
      const target = this.closest('.composer-block');
      if (target && target !== draggedItem) {
        document.querySelectorAll('.composer-block').forEach(b => b.classList.remove('drag-over'));
        target.classList.add('drag-over');
      }
    }

    function handleDrop(e) {
      e.stopPropagation();
      const target = this.closest('.composer-block');
      if (draggedItem && target && draggedItem !== target) {
        const rect = target.getBoundingClientRect();
        const after = (e.clientY - rect.top) / rect.height > 0.5;
        if (after) target.after(draggedItem);
        else target.before(draggedItem);
      }
    }

    function handleDragEnd() {
      this.classList.remove('dragging');
      draggedItem = null;
      document.querySelectorAll('.composer-block').forEach(b => b.classList.remove('drag-over'));
    }

    // --- Block Actions ---
    window.deleteBlock = (btn) => btn.closest('.composer-block').remove();
    window.duplicateBlock = (btn) => {
      const block = btn.closest('.composer-block');
      const clone = block.cloneNode(true);
      clone.addEventListener('click', (e) => { if (!e.target.closest('.block-actions') && !e.target.closest('.cell-placeholder')) selectBlock(clone); });
      clone.addEventListener('dragstart', handleDragStart);
      clone.addEventListener('dragover', handleDragOver);
      clone.addEventListener('drop', handleDrop);
      clone.addEventListener('dragend', handleDragEnd);
      block.after(clone);
    };

    // --- Insert Menu ---
    addBlockBtn.addEventListener('click', (e) => {
      const rect = addBlockBtn.getBoundingClientRect();
      insertMenu.style.left = `${rect.left}px`;
      insertMenu.style.top = `${rect.top - insertMenu.offsetHeight - 10}px`;
      insertMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!insertMenu.contains(e.target) && e.target !== addBlockBtn && !addBlockBtn.contains(e.target)) {
        insertMenu.classList.add('hidden');
      }
      if (!cellMenu.contains(e.target) && !e.target.closest('.cell-placeholder')) {
        cellMenu.classList.add('hidden');
      }
    });

    window.insertBlock = (type) => {
      const block = createBlock(type);
      contentEl.appendChild(block);
      insertMenu.classList.add('hidden');
      selectBlock(block);
      const editable = block.querySelector('[contenteditable]');
      if (editable) editable.focus();
    };

    // --- Media Handlers ---
    window.uploadImage = (el) => el.querySelector('input[type="file"]').click();
    window.handleImageUpload = (input) => {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const placeholder = input.closest('.media-placeholder');
          placeholder.outerHTML = `<img src="${e.target.result}" alt="Uploaded image" class="rounded-lg max-w-full h-auto" />`;
        };
        reader.readAsDataURL(file);
      }
    };

    window.promptVideoUrl = (el) => {
      const url = prompt('Enter YouTube or Vimeo URL:');
      if (url) {
        let embedUrl = '';
        if (url.includes('youtube.com') || url.includes('youtu.be')) {
          const videoId = url.includes('youtu.be') ? url.split('/').pop() : new URL(url).searchParams.get('v');
          embedUrl = `https://www.youtube.com/embed/${videoId}`;
        } else if (url.includes('vimeo.com')) {
          const videoId = url.split('/').pop();
          embedUrl = `https://player.vimeo.com/video/${videoId}`;
        }
        if (embedUrl) {
          el.outerHTML = `<div class="aspect-video bg-black rounded-lg overflow-hidden"><iframe src="${embedUrl}" class="w-full h-full" frameborder="0" allowfullscreen></iframe></div>`;
        }
      }
    };

    // --- Commands ---
    window.execCmd = (cmd, val = null) => document.execCommand(cmd, false, val);

    window.insertLink = () => {
      const url = prompt('Enter URL:', 'https://');
      if (url) document.execCommand('createLink', false, url);
    };

    // Text Type Dropdown
    window.toggleTextTypeMenu = () => {
      const menu = document.getElementById('text-type-menu');
      menu.classList.toggle('hidden');
    };

    window.setTextType = (tag) => {
      document.execCommand('formatBlock', false, tag);
      const labelMap = { 'H1': 'Heading 1', 'H2': 'Heading 2', 'H3': 'Heading 3', 'P': 'Normal', 'BLOCKQUOTE': 'Quote' };
      document.getElementById('text-type-label').textContent = labelMap[tag] || 'Normal';
      document.getElementById('text-type-menu').classList.add('hidden');
    };

    // Toggle Lists (properly toggle on/off)
    window.toggleList = (listCmd) => {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      const parent = selection.anchorNode.parentElement.closest('ul, ol');
      if (parent) {
        // Already in a list - remove list formatting
        document.execCommand('insertParagraph', false, null);
        document.execCommand('outdent', false, null);
      } else {
        // Not in a list - add list
        document.execCommand(listCmd, false, null);
      }
    };

    // Close text type menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('text-type-menu');
      const btn = document.getElementById('text-type-btn');
      if (menu && !menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });

    // --- Template & Type ---
    window.selectTemplate = (type) => {
      console.log('selectTemplate called with:', type);
      currentType = type;
      currentId = null;
      const t = templates[type];

      if (!t) {
        console.error('Template not found for type:', type);
        return;
      }

      titleEl.innerText = t.title;
      contentEl.innerHTML = '';

      t.blocks.forEach((b, index) => {
        try {
          const block = createBlock(b.type, b.content);
          contentEl.appendChild(block);
        } catch (err) {
          console.error(`Error creating block ${index} (${b.type}):`, err);
        }
      });

      typeLabel.textContent = t.config.label;
      typeIcon.textContent = t.config.icon;
      metaStatus.value = 'draft';
      metaTags.value = '';
      deleteBtn.classList.add('hidden');
      statusEl.innerHTML = "<span class='size-2 rounded-full bg-slate-300'></span> Unsaved";
      showEditor();
    };

    window.setType = (type) => {
      currentType = type;
      const config = templates[type].config;
      typeLabel.textContent = config.label;
      typeIcon.textContent = config.icon;
    };

    // --- View Switching ---
    function showTemplateGallery() {
      templateGallery.classList.remove('hidden');
      templateGallery.classList.add('flex');
      editorWrapper.classList.add('hidden');
      editorWrapper.classList.remove('flex');
    }

    function showEditor() {
      templateGallery.classList.add('hidden');
      templateGallery.classList.remove('flex');
      editorWrapper.classList.remove('hidden');
      editorWrapper.classList.add('flex');
    }

    // --- Data Handling ---
    async function loadContents() {
      const result = await fetchContents();
      if (result.success) {
        allContents = result.data;
        renderList(allContents);
        if (!currentId) showTemplateGallery();
      } else {
        listEl.innerHTML = `<div class="p-4 text-red-500 text-sm">Failed to load.</div>`;
      }
    }

    function renderList(data, searchQuery = '') {
      listEl.innerHTML = '';
      const filterBtn = document.querySelector('button[data-filter].active-filter');
      const filterType = filterBtn ? filterBtn.dataset.filter : 'all';
      let filtered = filterType === 'all' ? data : data.filter(item => item.type === filterType);

      // Apply search filter
      if (searchQuery.trim()) {
        const query = searchQuery.toLowerCase();
        filtered = filtered.filter(item =>
          (item.title || '').toLowerCase().includes(query) ||
          (item.type || '').toLowerCase().includes(query) ||
          (item.tags || []).some(tag => tag.toLowerCase().includes(query))
        );
      }

      if (filtered.length === 0) {
        listEl.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm">${searchQuery ? 'No matching items.' : 'No items found.'}</div>`;
        return;
      }

      filtered.forEach(item => {
        const div = document.createElement('div');
        const isActive = item.id === currentId;
        div.className = `library-item group relative p-3 rounded-xl cursor-pointer border transition-all mb-2 ${isActive
          ? 'bg-primary/10 dark:bg-primary/20 border-primary ring-2 ring-primary/30 shadow-md'
          : 'border-transparent hover:bg-slate-100 dark:hover:bg-slate-800/50 hover:border-slate-200 dark:hover:border-slate-700'}`;
        div.dataset.itemId = item.id;

        const iconMap = { article: 'article', email: 'mail', casestudy: 'work_history' };
        const typeName = item.type || 'article';
        const date = item.updatedAt ? new Date(item.updatedAt.seconds * 1000).toLocaleDateString() : 'Just now';

        div.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="size-8 rounded-lg ${isActive ? 'bg-primary text-white' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'} flex items-center justify-center shrink-0 transition-colors">
              <span class="material-symbols-outlined text-[16px]">${iconMap[typeName]}</span>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="font-semibold text-sm ${isActive ? 'text-primary dark:text-primary' : 'text-slate-800 dark:text-slate-100'} truncate mb-1">${item.title || 'Untitled'}</h4>
              <div class="text-xs text-slate-400">${typeName} â€¢ ${date}</div>
            </div>
          </div>
          <!-- Action Buttons (visible on hover) -->
          <div class="absolute right-2 top-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="event.stopPropagation(); duplicateItem('${item.id}')" class="p-1.5 rounded-lg bg-white dark:bg-slate-700 shadow-sm hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-500 hover:text-primary transition-colors" title="Duplicate">
              <span class="material-symbols-outlined text-[14px]">content_copy</span>
            </button>
            <button onclick="event.stopPropagation(); shareItem('${item.id}')" class="p-1.5 rounded-lg bg-white dark:bg-slate-700 shadow-sm hover:bg-slate-100 dark:hover:bg-slate-600 text-slate-500 hover:text-primary transition-colors" title="Share">
              <span class="material-symbols-outlined text-[14px]">share</span>
            </button>
            <button onclick="event.stopPropagation(); deleteItemFromList('${item.id}')" class="p-1.5 rounded-lg bg-white dark:bg-slate-700 shadow-sm hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-500 hover:text-red-500 transition-colors" title="Delete">
              <span class="material-symbols-outlined text-[14px]">delete</span>
            </button>
          </div>
        `;

        div.addEventListener('click', () => loadItem(item));
        listEl.appendChild(div);
      });
    }

    function loadItem(item) {
      currentId = item.id;
      currentType = item.type || 'article';

      titleEl.innerText = item.title || '';
      metaStatus.value = item.status || 'draft';
      metaTags.value = (item.tags || []).join(', ');

      contentEl.innerHTML = '';
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = item.content || '<p></p>';

      Array.from(tempDiv.children).forEach(child => {
        const type = child.dataset?.blockType || 'text';
        contentEl.appendChild(createBlock(type, child.innerHTML));
      });

      if (tempDiv.children.length === 0 && tempDiv.innerText.trim()) {
        contentEl.appendChild(createBlock('text', `<p>${tempDiv.innerText}</p>`));
      }

      setType(currentType);
      deleteBtn.classList.remove('hidden');
      renderList(allContents);
      showEditor();
      statusEl.innerHTML = "<span class='size-2 rounded-full bg-green-500'></span> Loaded";
    }

    // --- CRUD ---
    document.getElementById('btn-new-content').onclick = () => {
      currentId = null;
      showTemplateGallery();
    };

    document.getElementById('btn-save').onclick = async () => {
      const btn = document.getElementById('btn-save');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-[16px]">progress_activity</span> Saving...`;

      let cleanHTML = '';
      document.querySelectorAll('#editor-content .composer-block').forEach(block => {
        const type = block.dataset.type || 'text';
        const content = block.querySelector('.block-content').innerHTML;
        cleanHTML += `<div data-block-type="${type}">${content}</div>`;
      });

      const data = {
        id: currentId,
        type: currentType,
        title: titleEl.innerText,
        content: cleanHTML,
        status: metaStatus.value,
        tags: metaTags.value.split(',').map(t => t.trim()).filter(t => t),
      };

      const result = await saveContent(data);
      btn.disabled = false;
      btn.innerHTML = originalText;

      if (result.success) {
        statusEl.innerHTML = "<span class='size-2 rounded-full bg-green-500'></span> Saved";
        currentId = result.id;
        deleteBtn.classList.remove('hidden');
        if (window.showToast) window.showToast('Content saved!', 'success');
        loadContents();
      } else {
        statusEl.innerHTML = "<span class='size-2 rounded-full bg-red-500'></span> Failed";
        if (window.showToast) window.showToast('Save failed', 'error');
      }
    };

    deleteBtn.onclick = async () => {
      if (!confirm("Delete this content permanently?")) return;
      const result = await deleteContent(currentId);
      if (result.success) {
        if (window.showToast) window.showToast('Deleted', 'success');
        currentId = null;
        showTemplateGallery();
        loadContents();
      } else {
        if (window.showToast) window.showToast('Delete failed', 'error');
      }
    };

    // --- Filters ---
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('[data-filter]').forEach(b => {
          b.classList.remove('bg-slate-200', 'dark:bg-slate-700', 'active-filter');
          b.classList.add('bg-transparent', 'text-slate-500');
        });
        btn.classList.add('bg-slate-200', 'dark:bg-slate-700', 'active-filter');
        btn.classList.remove('bg-transparent');
        const searchQuery = document.getElementById('library-search')?.value || '';
        renderList(allContents, searchQuery);
      };
    });

    // --- Library Search ---
    const librarySearch = document.getElementById('library-search');
    if (librarySearch) {
      librarySearch.addEventListener('input', (e) => {
        renderList(allContents, e.target.value);
      });
    }

    // --- Library Item Actions ---
    window.duplicateItem = async (itemId) => {
      const item = allContents.find(i => i.id === itemId);
      if (!item) return;

      const newData = {
        title: `${item.title || 'Untitled'} (Copy)`,
        content: item.content,
        type: item.type,
        status: 'draft',
        tags: item.tags || []
      };

      const result = await saveContent(newData);
      if (result.success) {
        if (window.showToast) window.showToast('Content duplicated!', 'success');
        loadContents();
      } else {
        if (window.showToast) window.showToast('Duplication failed', 'error');
      }
    };

    window.shareItem = (itemId) => {
      const item = allContents.find(i => i.id === itemId);
      if (!item) return;

      const shareUrl = `${window.location.origin}/portal/composer.html?id=${itemId}`;

      if (navigator.share) {
        navigator.share({
          title: item.title || 'Shared Content',
          text: `Check out: ${item.title || 'Untitled'}`,
          url: shareUrl
        }).catch(() => {
          copyToClipboard(shareUrl);
        });
      } else {
        copyToClipboard(shareUrl);
      }
    };

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        if (window.showToast) window.showToast('Link copied to clipboard!', 'success');
      }).catch(() => {
        if (window.showToast) window.showToast('Failed to copy link', 'error');
      });
    }

    window.deleteItemFromList = async (itemId) => {
      if (!confirm('Are you sure you want to delete this item?')) return;

      const result = await deleteContent(itemId);
      if (result.success) {
        allContents = allContents.filter(i => i.id !== itemId);
        if (currentId === itemId) {
          currentId = null;
          showTemplateGallery();
        }
        const searchQuery = document.getElementById('library-search')?.value || '';
        renderList(allContents, searchQuery);
        if (window.showToast) window.showToast('Item deleted!', 'success');
      } else {
        if (window.showToast) window.showToast('Delete failed', 'error');
      }
    };

    // --- Preview ---
    const previewModal = document.getElementById('preview-modal');
    const previewFrame = document.getElementById('preview-frame');
    const previewContent = document.getElementById('preview-content');

    document.getElementById('btn-preview').onclick = () => {
      openPreview();
    };

    window.openPreview = () => {
      // Gather content
      const title = titleEl.innerText || 'Untitled';
      const blocks = Array.from(contentEl.children).map(block => {
        const content = block.querySelector('.block-content');
        return content ? content.innerHTML : '';
      }).join('');

      // Build preview HTML
      previewContent.innerHTML = `
        <article class="prose prose-slate max-w-none">
          <h1 class="text-2xl font-bold text-slate-900 mb-4">${title}</h1>
          ${blocks}
        </article>
      `;

      previewModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    };

    window.closePreview = () => {
      previewModal.classList.add('hidden');
      document.body.style.overflow = '';
    };

    window.setPreviewDevice = (device) => {
      // Update active button
      document.querySelectorAll('.preview-device-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.device === device);
      });

      // Set dimensions
      const dimensions = {
        mobile: { width: '375px', height: '667px' },
        tablet: { width: '768px', height: '1024px' },
        desktop: { width: '100%', height: '100%', maxWidth: '1200px' }
      };

      const dim = dimensions[device];
      previewFrame.style.width = dim.width;
      previewFrame.style.height = dim.height;
      if (dim.maxWidth) {
        previewFrame.style.maxWidth = dim.maxWidth;
      } else {
        previewFrame.style.maxWidth = '';
      }
    };

    // Close preview on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !previewModal.classList.contains('hidden')) {
        closePreview();
      }
    });

    // --- Sidebar Tabs ---
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active-tab'));
        tab.classList.add('active-tab');

        const targetPanel = tab.dataset.tab;
        document.querySelectorAll('.tab-panel').forEach(panel => {
          if (panel.dataset.panel === targetPanel) {
            panel.classList.remove('hidden');
          } else {
            panel.classList.add('hidden');
          }
        });
      };
    });

    // --- Keyboard Shortcuts ---
    document.addEventListener('keydown', (e) => {
      // Delete selected block with Delete or Backspace key (when not editing text)
      if (e.key === 'Delete' || e.key === 'Backspace') {
        const activeEl = document.activeElement;
        const isEditing = activeEl && (
          activeEl.isContentEditable ||
          activeEl.tagName === 'INPUT' ||
          activeEl.tagName === 'TEXTAREA'
        );

        if (!isEditing) {
          const selectedBlock = document.querySelector('.composer-block.selected');
          if (selectedBlock) {
            e.preventDefault();
            const prevBlock = selectedBlock.previousElementSibling;
            const nextBlock = selectedBlock.nextElementSibling;
            selectedBlock.remove();

            // Select the next or previous block
            if (nextBlock && nextBlock.classList.contains('composer-block')) {
              selectBlock(nextBlock);
            } else if (prevBlock && prevBlock.classList.contains('composer-block')) {
              selectBlock(prevBlock);
            }
          }
        }
      }
    });

  </script>
</body>

</html>